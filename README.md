Рассмотренные варианты создания обратного прокси, который бы по результату на 
подзапрос проксировал на /epay1 или /epay2:

#### NJS модуль для NGINX.

Модуль отлично развивается и достаточно хорошо поддерживается. Но так как модуль 
относительно новый, то есть некоторые ограничения в функциональности.

**Вариант 1.** Использовать директиву js_set для присвоения переменной в nginx.
Так как в функции используется подзапрос, а он асинхронный, то присвоить значение
переменной до обработки следующей строки в настройке не является возможным,
так как пока не поддерживается функционал async/await.

Ссылка на схожий Issue с ответом от контрибютера: https://github.com/nginx/njs/issues/31

**Вариант 2.** Если использовать директиву nginx auth_request, то можно добиться того, что 
проксирование будет дожидаться успешного ответа от auth_request. Auth_Request передать
в директиву js_content, где будет произведен подзапрос, и в зависимости от ответа
присвоить значение переменной $proxy_pass. 

В нашем случае такой вариант также не является возможным, так как данные по 
которым определяется мигрирован клиент или нет присутсвтует только в body. По специфике 
nginx, при auth_request тело запроса не передается в директиву auth_request.

Подробнее здесь https://stackoverflow.com/questions/40645270/nginx-auth-request-handler-accessing-post-request-body

*Пример настройки тут в проекте*
#### Другие возможные решения

**1. LuaJit** отличная библиотека, есть в нем возможность решить данный кейс,
но несовместим с nginx 1.19.1, поддержка чистого nginx прекратилась с 1.16.1.

**2. Nginx-Clojure** библиотека работает с Groovy. Хорошо работает с nginx 1.14.2,
не совместим с более высокими версиями. Так же более сложен в установке, необходимо устанавливать 
jvm.

Есть и другие решения, но вижу риск, что мелкие библиотеки не поддерживаюся и не 
развиваются, а те что имеют хороший комьюнити и хорошее развитие, не подходят
по ряду причин описанных выше.

#### Решение
Лучшим решением будет проксировать в микросервис, который определит мигрирован ли 
мерчант, и отправит его далее в нужный сервис.